４.9
IPsec（Security Architecture for Internet Protocol）はネットワーク層でIPパケットのカプセル化や認証暗号化を行い、インターネット上に仮想的な専用線を作る仮想化技術。

４.９.1
拠点間IPsec VPNとはいろいろな場所に拠点がある企業の接奥に使用されている。世界各地にある拠点をそれぞれ専用線で接続していたらお金がかかり過ぎてしまう。そこでIPsecを使用してインターネット上に仮想的な直結回線を作ってあたかも専用線で接続されているかのように拠点のネットワークを説奥する。インターネットの接続料金だけで拠点間を接続できるため、大幅なコストダウンを図ることができる。

リモートアクセスIPsec VPNとはモバイルユーザやテレワーかのリモートアクセスで使用されている。自宅からテレワークするような場合にOSの標準機能やサードパーティ性のVPNソフトウェアなどを使用してVPN用の仮想的なNICを作りVPN装置にIPsecトンネルを作る。

４.９.2
IPsecはIKE（Internet Key Exchange)とESP（Encapsulating Security Payload)とAH（Authentication Header）という３つのプロトコルを組み合わせてVPNを作るために必要な機能を提供する。

IKE
IPsecは行きなるトンネルができるわけではなく、安全に通信するために事前準備をしてからトンネルを作る。この事前準備のことあるいはそれに使用するプロトコルのことをIKEという。IKEにはIKEv1とIKEv2の２つがある。

IKEv1
IKEv1はフェーズ１とフェーズ２という二つのフェーズで構成されている。
フェーズ1はトンネルを制御するISAKMP SA（Internet Security Association and Key Management Protocol Security Association）を作るフェーズのこと。暗号鍵の共有、接続相手の認証を行う。フェーズ１にはメインモードとアグレッシブモードという２種類の交換手順がある。

メインモードは「設定の合意」　「暗号鍵の共有」　「接続相手の認証」の順に3ステップの処理を行う。
アグレッシブモードはメインモードを簡略化したモードで設定の合意、暗号鍵の共有、接奥相手の認証を1ステップで一気に行う。
接続への時間は短いが、認証情報が暗号化されずに流れるため、メインモードよりセキュリティレベルが低いという難点がある。

フェーズ１の処理が終わるとフェーズ2に移行する。フェーズ２では実際のデータをやり取りするIPsec SAを作るフェーズになる。

IKEv2
IKEv2は長きにわたって使われてきたプロトコル。しかし、時代に合わせていろいろな拡張機能が追加されたため、メーカや機種、バージョンによって実装状態が異なり、相性問題が発生しやすいという欠点がある。
そこで、この昏倒とした状態を解消すべく、いろいろな機能を統合し、新たに標準化されたプロトコルがIKEv2だ。IKEv2はIKE _SA _INITとIKE _AUTHに分かれている

IKE _SA _INITはトンネルを制御するコネクションであるIKE SAを作るステップでIKEv1のフェーズ1と同じような役割を担う。

IKE_AUTHは実際のデータをやり取りするトンネルであるChild SAを作るステップでフェーズ2のような役割を担う。

IKEによる事前準備が完了したらデータ転送を開始する。IPsec\Child SAではESP（Encapsulating Security Payload)かAH（Authentication Header)のどちらかのプロトコルを使用する。ESPとAHの違いは暗号化機能があるかどうかだ。ESPが暗号化機能を備えているのに対して、AHは暗号化機能を備えていない。AHはデータの暗号化が制限されているような国で使用するプロトコルだが、日本ではそのような取り決めはないのでわざわざAHを選ぶ必要はない。

IPsec\Child SAにはトンネルも０度とトランスポートモードという２つの動作モードがある。トンネルもーどはオリジナルIPパケットをさらに新しいIPヘッダーでカプセル化するモード。拠点間IPsecや一般的なリモートアクセスIPsec VPNで使用する。トランスポートモードはオリジナルIPパケットにトンネル用のヘッダーを差し込むモード。トンネルモードとトランスポートモードはESPかAH のどちらを使用するかによって暗号化やメッセージ認証の範囲が異なる。

NATトラバーサルとはIPsec VPNで使用されているとても重要な機能。NATとラバーサルというばNATを超える技術だった。

